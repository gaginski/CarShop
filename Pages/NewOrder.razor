@page "/orders/new/{CarId:long}"

@using System.Security.Claims
@using CarShop.Data
@using CarShop.Models
@using CarShop.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@attribute [Authorize(Roles = "User")]

@inject ApplicationDbContext Db
@inject SalesService Sales
@inject AuthenticationStateProvider AuthStateProvider


<h3>Nova venda</h3>


<div class="card mb-3">
    <div class="card-body">
        <h5>@car.Brand @car.Model (@car.Year)</h5>
        <p>Cor: @car.Color</p>
        <p>Km: @car.Km</p>
        <p>Pre√ßo: @car.Price.ToString("N2")</p>
    </div>
</div>

<EditForm Model="model" OnValidSubmit="SaveOrder">
    <div class="mb-2">
        <label class="form-label">Nome do cliente</label>
        <InputText class="form-control" @bind-Value="model.CustomerName" />
    </div>

    <div class="mb-2">
        <label class="form-label">Desconto</label>
        <InputNumber class="form-control" @bind-Value="model.Discount" />
    </div>

    <div class="mb-3">
        <label class="form-label">Total</label>
        <input class="form-control" value="@FinalPrice.ToString("N2")" disabled />
    </div>

    <button type="submit" class="btn btn-success">Confirmar venda</button>
</EditForm>

@if (orderCreated)
{
    <div class="alert alert-success mt-3">
        Venda registrada. Pedido: @createdOrderId
    </div>
}

@code {
    [Parameter] public long CarId { get; set; }

    private Car? car;
    private NewOrderModel model = new();
    private bool orderCreated;
    private long createdOrderId;

    private bool isVendor;
    private int currentVendorId;

    private decimal FinalPrice => car == null ? 0 : (decimal)car.Price - model.Discount;

    protected override async Task OnInitializedAsync()
    {
        try
        {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        isVendor = user.IsInRole("User"); 

        if (isVendor)
        {
            var idClaim = user.FindFirst(ClaimTypes.NameIdentifier);
            if (idClaim != null && int.TryParse(idClaim.Value, out var id))
            {
                currentVendorId = id;
            }
        }

        car = Db.Cars.FirstOrDefault(c => c.Id == CarId);
        }
        catch(Exception ex)
        {

        }
    }

    private async Task SaveOrder()
    {
        if (!isVendor || car == null)
            return;

        var order = await Sales.CreateOrderAsync(
            car.Id,
            model.CustomerName,
            model.Discount,
            currentVendorId
        );

        orderCreated = true;
        createdOrderId = order.Order.Id;
    }

    public class NewOrderModel
    {
        public string CustomerName { get; set; } = string.Empty;
        public decimal Discount { get; set; }
    }
}

