@page "/orders"
@inject ApplicationDbContext Db
@inject SessionService Session
@using Microsoft.EntityFrameworkCore
@using CarShop.Models

<h3>Pedidos</h3>

@if (!Session.IsLoggedIn)
{
    <p>Faça login para acessar esta página.</p>
}
else
{
    <table class="table table-striped table-sm">
        <thead>
            <tr>
                <th>Id</th>
                <th>Cliente</th>
                <th>Data</th>
                <th>Total</th>
                <th>Vendedor</th>
                @if (Session.IsAdmin)
                {
                    <th>Comissão (%)</th>
                    <th>Comissão</th>
                }
            </tr>
        </thead>
        <tbody>
            @foreach (var item in orders)
            {
                <tr>
                    <td>@item.Order.Id</td>
                    <td>@item.Order.CustomerName</td>
                    <td>@item.Order.OrderDate.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                    <td>@item.Order.Total.ToString("N2")</td>
                    <td>@item.Order.VendorId</td>
                    @if (Session.IsAdmin)
                    {
                        <td>@(item.Commission?.ComissionPercentage.ToString("N2") ?? "-")</td>
                        <td>@(item.Commission?.ComissionAmount.ToString("N2") ?? "-")</td>
                    }
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<OrderWithCommission> orders = new List<OrderWithCommission>();

    protected override async Task OnInitializedAsync()
    {
        if (!Session.IsLoggedIn)
        {
            return;
        }

        if (Session.IsAdmin)
        {
            orders = await (
                from o in Db.Orders
                join c in Db.VendorComissions on o.Id equals c.OrderId into oc
                from c in oc.DefaultIfEmpty()
                orderby o.OrderDate descending
                select new OrderWithCommission
                {
                    Order = o,
                    Commission = c
                }).ToListAsync();
        }
        else if (Session.IsVendor)
        {
            var id = Session.CurrentUser!.Id;

            orders = await (
                from o in Db.Orders
                join c in Db.VendorComissions on o.Id equals c.OrderId into oc
                from c in oc.DefaultIfEmpty()
                where o.VendorId == id
                orderby o.OrderDate descending
                select new OrderWithCommission
                {
                    Order = o,
                    Commission = c
                }).ToListAsync();
        }
    }

    private class OrderWithCommission
    {
        public Order Order { get; set; } = null!;
        public VendorComission? Commission { get; set; }
    }
}
