@page "/cars"
@inject ApplicationDbContext Db
@inject SessionService Session
@using CarShop.Models

<h3>Carros</h3>

@if (!Session.IsLoggedIn)
{
    <p>Faça login para acessar esta página.</p>
}
else
{
    <div class="mb-2">
        @if (Session.IsAdmin)
        {
            <button class="btn btn-primary" @onclick="NewCar">Novo carro</button>
        }
    </div>

    <table class="table table-striped table-sm">
        <thead>
            <tr>
                <th>Marca</th>
                <th>Modelo</th>
                <th>Ano</th>
                <th>Km</th>
                <th>Preço</th>
                <th>Cor</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var car in cars)
            {
                <tr>
                    <td>@car.Brand</td>
                    <td>@car.Model</td>
                    <td>@car.Year</td>
                    <td>@car.Km</td>
                    <td>@car.Price.ToString("N2")</td>
                    <td>@car.Color</td>
                    <td class="text-end">
                        @if (Session.IsAdmin)
                        {
                            <button class="btn btn-sm btn-outline-secondary me-1" @onclick="() => EditCar(car)">Editar</button>
                            <button class="btn btn-sm btn-outline-danger me-1" @onclick="() => DeleteCar(car)">Excluir</button>
                            <a class="btn btn-sm btn-outline-primary me-1" href="@($"/cars/{car.Id}/images")">Imagens</a>
                        }
                        @if (Session.IsVendor)
                        {
                            <a class="btn btn-sm btn-success" href="@($"/orders/new/{car.Id}")">Vender</a>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>

    @if (editingCar != null)
    {
        <div class="card mt-3">
            <div class="card-header">
                @(editingCar.Id == 0 ? "Novo carro" : "Editar carro")
            </div>
            <div class="card-body">
                <EditForm Model="editingCar" OnValidSubmit="SaveCar">
                    <div class="row g-2">
                        <div class="col-md-4">
                            <label class="form-label">Marca</label>
                            <InputText class="form-control" @bind-Value="editingCar.Brand" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Modelo</label>
                            <InputText class="form-control" @bind-Value="editingCar.Model" />
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Ano</label>
                            <InputNumber class="form-control" @bind-Value="editingCar.Year" />
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Km</label>
                            <InputNumber class="form-control" @bind-Value="editingCar.Km" />
                        </div>
                    </div>

                    <div class="row g-2 mt-2">
                        <div class="col-md-3">
                            <label class="form-label">Preço</label>
                            <InputNumber class="form-control" @bind-Value="editingCar.Price" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Cor</label>
                            <InputText class="form-control" @bind-Value="editingCar.Color" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Novo</label>
                            <InputCheckbox class="form-check-input ms-2" @bind-Value="editingCar.New" />
                        </div>
                    </div>

                    <div class="mt-2">
                        <label class="form-label">Descrição</label>
                        <InputTextArea class="form-control" @bind-Value="editingCar.Description" />
                    </div>

                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary me-2">Salvar</button>
                        <button type="button" class="btn btn-secondary" @onclick="CancelEdit">Cancelar</button>
                    </div>
                </EditForm>
            </div>
        </div>
    }
}

@code {
    private List<Car> cars = new List<Car>();
    private Car? editingCar;

    protected override async Task OnInitializedAsync()
    {
        cars = await Db.Cars.OrderBy(c => c.Brand).ThenBy(c => c.Model).ToListAsync();
    }

    private void NewCar()
    {
        editingCar = new Car();
    }

    private void EditCar(Car car)
    {
        editingCar = new Car
        {
            Id = car.Id,
            New = car.New,
            Brand = car.Brand,
            Model = car.Model,
            Year = car.Year,
            Price = car.Price,
            Color = car.Color,
            Km = car.Km,
            Description = car.Description
        };
    }

    private void CancelEdit()
    {
        editingCar = null;
    }

    private async Task SaveCar()
    {
        if (editingCar == null)
        {
            return;
        }

        if (editingCar.Id == 0)
        {
            Db.Cars.Add(editingCar);
        }
        else
        {
            Db.Cars.Update(editingCar);
        }

        await Db.SaveChangesAsync();
        cars = await Db.Cars.OrderBy(c => c.Brand).ThenBy(c => c.Model).ToListAsync();
        editingCar = null;
        StateHasChanged();
    }

    private async Task DeleteCar(Car car)
    {
        Db.Cars.Remove(car);
        await Db.SaveChangesAsync();
        cars = await Db.Cars.OrderBy(c => c.Brand).ThenBy(c => c.Model).ToListAsync();
        StateHasChanged();
    }
}
