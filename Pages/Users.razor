@page "/users"
@using CarShop.Data
@using CarShop.Models
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@attribute [Authorize(Roles = "Admin")]

@inject ApplicationDbContext Db
@inject AuthenticationStateProvider AuthState

<h3 class="mb-3 ms-3">Usuários</h3>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="alert alert-success">@successMessage</div>
}

<div class="card shadow-sm">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle mb-0 w-100">
                <thead class="table-light">
                    <tr>
                        <th style="width: 70px;">Id</th>
                        <th>Usuário</th>
                        <th>Nome</th>
                        <th>Role</th>
                        <th>Comissão (%)</th>
                        <th class="text-end" style="width: 160px;">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var u in users)
                    {
                        <tr>
                            <td>@u.Id</td>
                            <td>@u.Username</td>
                            <td>@u.Email</td> @* ou Nome, se tiver outra propriedade *@
                            <td>@(u.Role == 1 ? "Vendedor" : "Admin")</td>
                            <td>@(u.ComissionPerSaleInPercent?.ToString("N2") ?? "-")</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-secondary me-1"
                                        @onclick="() => EditUser(u)">
                                    Editar
                                </button>
                                <button class="btn btn-sm btn-outline-danger"
                                        @onclick="() => DeleteUser(u)">
                                    Excluir
                                </button>
                            </td>
                        </tr>

                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="mt-4">
    <button class="btn btn-primary w-100"
            @onclick="NewUser">
        + Novo usuário
    </button>
</div>

@if (editingUser != null)
{
    <div class="card mt-4">
        <div class="card-header">
            @(editingUser.Id == 0 ? "Novo usuário" : "Editar usuário")
        </div>
        <div class="card-body">
            <EditForm Model="editingUser" OnValidSubmit="SaveUser">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="row g-2">
                    <div class="col-md-4">
                        <label class="form-label">Usuário (login)</label>
                        <InputText class="form-control" @bind-Value="editingUser.Username" />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Email</label>
                        <InputText class="form-control" @bind-Value="editingUser.Email" />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Tipo de Usuário</label>
                        <InputSelect class="form-select" @bind-Value="editingUser.Role">
                            @* NÃO usar value="" com int, isso quebra o bind *@
                            <option value="0">Admin</option>
                            <option value="1">Vendedor</option>
                        </InputSelect>
                    </div>
                </div>

                <div class="row g-2 mt-2">
                    <div class="col-md-4">
                        <label class="form-label">
                            Senha
                            @if (editingUser.Id != 0)
                            {
                                <small class="text-muted">(deixe em branco para manter)</small>
                            }
                        </label>
                        <InputText class="form-control"
                                   type="password"
                                   @bind-Value="passwordInput" />
                    </div>

           
                </div>
                <div class="col-md-4">
                    <label class="form-label">Comissão (%)</label>
                    <InputNumber class="form-control" @bind-Value="editingUser.ComissionPerSaleInPercent" />
                </div>

                <div class="mt-3 d-flex gap-2">
                    <button type="submit" class="btn btn-primary">Salvar</button>
                    <button type="button" class="btn btn-secondary" @onclick="CancelEdit">Cancelar</button>
                </div>
            </EditForm>
        </div>
    </div>
}

@code {
    private List<User> users = new();
    private User? editingUser;
    private string passwordInput = string.Empty;
    private string? errorMessage;
    private string? successMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadUsersAsync();
    }

    private async Task LoadUsersAsync()
    {
        errorMessage = null;
        successMessage = null;

        try
        {
            users = await Db.Users
                .OrderBy(u => u.Username)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            errorMessage = "Erro ao carregar usuários: " + ex.Message;
            Console.WriteLine(ex);
        }
    }

    private void NewUser()
    {
        editingUser = new User
        {
            Role = 0,
            ComissionPerSaleInPercent = null
        };
        passwordInput = string.Empty;
        successMessage = null;
        errorMessage = null;
    }

    private void EditUser(User u)
    {
        editingUser = new User
        {
            Id = u.Id,
            Username = u.Username,
            Password = u.Password,
            Email = u.Email,
            Role = u.Role,
            ComissionPerSaleInPercent = u.ComissionPerSaleInPercent
        };

        passwordInput = string.Empty;
        successMessage = null;
        errorMessage = null;
    }

    private void CancelEdit()
    {
        editingUser = null;
        passwordInput = string.Empty;
    }

    private async Task SaveUser()
    {
        if (editingUser == null)
            return;

        errorMessage = null;
        successMessage = null;

        try
        {
            if (editingUser.Id == 0)
            {
                // novo usuário
                if (string.IsNullOrWhiteSpace(passwordInput))
                {
                    errorMessage = "Informe uma senha para o novo usuário.";
                    return;
                }

                editingUser.Password = passwordInput;
                Db.Users.Add(editingUser);
            }
            else
            {
                // edição
                var dbUser = await Db.Users.FirstOrDefaultAsync(u => u.Id == editingUser.Id);
                if (dbUser == null)
                {
                    errorMessage = "Usuário não encontrado.";
                    return;
                }

                dbUser.Username = editingUser.Username;
                dbUser.Email = editingUser.Email;
                dbUser.Role = editingUser.Role;
                dbUser.ComissionPerSaleInPercent = editingUser.ComissionPerSaleInPercent;

                if (!string.IsNullOrWhiteSpace(passwordInput))
                {
                    dbUser.Password = passwordInput;
                }
            }

            await Db.SaveChangesAsync();
            await LoadUsersAsync();

            editingUser = null;
            passwordInput = string.Empty;
            successMessage = "Usuário salvo com sucesso.";
        }
        catch (Exception ex)
        {
            errorMessage = "Erro ao salvar usuário: " + ex.Message;
            Console.WriteLine(ex);
        }
    }

    private async Task DeleteUser(User u)
    {
        errorMessage = null;
        successMessage = null;

        try
        {
            Db.Users.Remove(u);
            await Db.SaveChangesAsync();

            await LoadUsersAsync();
            successMessage = "Usuário excluído com sucesso.";
        }
        catch (Exception ex)
        {
            errorMessage = "Erro ao excluir usuário: " + ex.Message;
            Console.WriteLine(ex);
        }
    }
}
